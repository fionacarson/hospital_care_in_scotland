---
title: "Investigating Data - Covid Cases"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

Looking at weekly covid cases
weekly variability split by age bands
note that although file contains health boards, data is not broken down by health board!


```{r}
library("tidyverse")
library("janitor")
library("lubridate")
library("tsibble")
library("tsibbledata")
```

load in datafile
```{r}
covid_cases <- read_csv(here::here("raw_data/admissions_ageband_week.csv"))
covid_cases <- clean_names(covid_cases)
```
data cleaning
```{r}
covid_cases <- covid_cases %>% 
 mutate(year = as.integer(str_sub(week_ending,1,4)), .after = week_ending) %>% 
  mutate(month = as.integer(str_sub(week_ending,5,6)), .after  =year) %>% 
  mutate(day = as.integer(str_sub(week_ending,7,8)), .after = month) %>% 
  mutate(wdate = ymd(week_ending), .after = week_ending) %>% 
  select(-week_ending) 
```

```{r}
covid_cases %>% 
  #distinct(age_band_qf)
  #distinct(age_band)
  distinct(admissions_qf)
```
lots of age bands including a Total
no quality flags on age band
some admissions have quality flag c - this indicates data would breach confidentiality
set this value to 1 (at least one person)

```{r}
covid_cases %>% 
  #distinct(age_band_qf)
  #distinct(age_band)
  filter(admissions_qf =="c")
```
example of where qf =c
```{r}
covid_cases %>% 
  #distinct(age_band_qf)
  #distinct(age_band)
  filter(wdate =="2021-04-04")
```

# decided to set values where qf = c to 1. we know there is at least one person.
# we are calculating weekly averages so confidential data will not be published.

more data cleaning
```{r}
covid_cases <- covid_cases %>% 
  rename(hb = country) %>% 
  mutate(hb_name = "All Scotland", .after = hb) %>% 
  mutate(age_band = ifelse(age_band == "Total", "All ages (0plus)", age_band)) %>% 
  mutate(admissions_qf = coalesce(" ")) %>% # so the next line works better
  mutate(admissions = ifelse(admissions_qf =="c",1,admissions)) %>% 
  select(-ends_with("qf")) 
```

```{r}
covid_cases %>% 
  distinct(age_band)
```


```{r}
covid_cases %>% 
  filter(age_band != "All ages (0plus)") %>% 
  ggplot() +
  aes(x=wdate, y=admissions, colour = age_band)+
  geom_line()
```


```{r}
# setup data as a tsibble
#covid_cases <- rowid_to_column(covid_cases, "id") 
#covid_cases<- as_tsibble(covid_cases, index = wdate, key = id)  
```


can see that covid cases don't have a simple winter/summer pattern - much more complex particularly coming into 2021.

```{r}
monthly_covid_cases <- covid_cases %>% 
  filter(age_band != "All ages (0plus)") %>% 
  group_by(age_band, year, month) %>% 
  mutate(monthly_admissions = sum(admissions, na.rm = TRUE)) %>% 
  mutate(mdate = as.Date(make_datetime(year, month, 15))) 
```

```{r}
monthly_covid_cases %>% 
ggplot() +
aes(x=mdate, y = monthly_admissions, fill = age_band) +
geom_col() 
```


```{r}
covid_cases %>% 
  group_by(age_band) %>% 
 summarise(total = sum(admissions, na.rm = TRUE)) %>% 
 arrange(desc(total))
```

boxplot for winter/summer
```{r}
covid_cases %>%
 filter(age_band != "Total") %>%   
 group_by(year, iswinter) %>% 
 ggplot()+
 aes(x=iswinter, y=admissions, fill = hb_name) +  
 geom_col() +
facet_grid(~year)
```


Now look by health boards 


```{r}
covid_cases %>% 
  filter(age_band == "Total") %>% 
  ggplot()+
  aes(x=wdate, y=admissions, colour = hb_name)+
  geom_line()+
  geom_line(aes(x=all_covid_cases$wdate, y =all_covid_cases$all_ages, colour = "red"))
```

