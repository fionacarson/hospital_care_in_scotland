---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(infer)
```

## define functions
```{r}
source(here::here("r_scripts_and_notebooks/fun_smoother.R"))
source(here::here("r_scripts_and_notebooks/stats_test.R"))
```

## note that data must just be one timeries
## date must be date format either weekly or monthly

## load data here
```{r}
admissions_spec <- read_csv(here::here("clean_data/weekly_admissions_spec_clean.csv")) 
delayed_discharge <- read_csv(here::here("clean_data/delayed_discharge_clean.csv"))  
```


```{r}
#define filters
input <- list(dataset = "delayed_discharge", age_group = "All (18plus)", healthboard = "All Scotland")
```


```{r}
selection <- 1
lookup_dataset <- list("delayed_discharge","admissions_spec")
lookup_param <- list("number_of_delayed_bed_days","number_admissions")
lookup_date <- list("wdate","mdate")
lookup_indicator <- list("weekly","monthly")
```


```{r}
#apply filters
eval(str2expression(str_c("seldata <- ",input$datase))) 

```

```{r}
eval(str2expression(str_c("seldata <- ",input$datase))) 
eval(str2expression(str_c("choice1=unique(seldata$",lookup_param[1],")")))
```

## start here ##

```{r}
seldata <- delayed_discharge %>% 
  filter(hb_name == "All Scotland") %>% 
  filter(age_group == "All (18plus)") %>% 
  filter(reason_for_delay == "Code 9 Non-AWI") %>% 
  #filter(mdate > as.Date("2020-04-01")) %>% 
  rename(param = number_of_delayed_bed_days) %>% 
  select(mdate, param, iswinter) 

data <- seldata[2]
date <- seldata[1]
```

## call function to smooth data
```{r}
smoothed_data <- data_smoother(date,seldata)
```
## call function to run test and calc p-value
```{r}
p_value <- stats_test(smoothed_data)
```



```{r}
## plot data
#calculate difference to create mvar
smoothed_data <- smoothed_data %>% 
  mutate(mvar = param - moving_avg) 
```

# plot - check the smoother makes sense and tweak values if they dont
```{r}
plotlim <- as.Date(c("2018-01-01","2022-12-31")) 
ggplot(smoothed_data) +
  geom_line(aes(x = mdate, y = c(param, moving_avg, mvar)) 

  scale_x_date(limits=plotlim, date_breaks="3 month", 
               labels = scales::label_date_short(), expand = c(0,0)) +
    # add dashed lines to show the boundaries 
    geom_vline(xintercept=ymd(20201001),color="gray",linetype="dotted", linewidth = 0.5) +          
    geom_vline(xintercept=ymd(20211001),color="gray",linetype="dotted", linewidth = 0.5) + 
    geom_vline(xintercept=ymd(20221001),color="gray",linetype="dotted", linewidth = 0.5) + 
    geom_vline(xintercept=ymd(20200401),color="gray",linetype="dotted", linewidth = 0.5) + 
    geom_vline(xintercept=ymd(20210401),color="gray",linetype="dotted", linewidth = 0.5) + 
    geom_vline(xintercept=ymd(20220401),color="gray",linetype="dotted", linewidth = 0.5) 
```
#now create a boxplot
```{r}
smoothed_data %>% 
  ggplot() +
  aes(x=iswinter, y=mvar) +
  geom_boxplot() +
  ylab("residual values (data - long term trend)") +
  xlab("Season") +
  scale_x_discrete(
    labels=c("FALSE" = "Summer (Apr-Sep)", "TRUE" = "Winter (Oct-Mar)"), 
    limits = c("FALSE","TRUE"))
```

### Hypothesis Test

Is summer is significantly different to winter?

The null hypothesis is that the average value for summer is the same or lower than the average value for winter.

H0 : mean winter - mean summer <= 0
HA : mean winter - mean summer >0 

we are setting alpha for this test to be 0.05
```{r}
alpha_test=0.05
```

```{r}
smoothed_data %>% 
  ggplot() +
  aes(x = mvar) +
  geom_histogram(col = "white")
```

```{r}
seasonal_avg <- smoothed_data  %>%
  group_by(iswinter) %>% 
  summarise(mean= mean(mvar, na.rm=TRUE))

seasonal_avg
observed_stat = seasonal_avg$mean[seasonal_avg$iswinter ==TRUE]
            -seasonal_avg$mean[seasonal_avg$iswinter ==FALSE]
```

```{r}
null_distribution <- smoothed_data  %>%
  specify(response = mvar, explanatory = iswinter) %>%
  hypothesize(null = "independence") %>%
  generate(reps = 1000, type = "permute") %>%
  calculate(stat = "diff in means", order = c(TRUE,FALSE)) #winter - summer
```

```{r}
null_distribution %>%
  visualise(bins = 30) + 
shade_p_value(obs_stat = observed_stat
            , direction = "greater")
 
p_value <- null_distribution %>% 
get_p_value(obs_stat = observed_stat
            , direction = "greater")
pull()
```

```{r}
p_value 
```
If pvalue is less than alpha we can reject null hypothesis

```{r}
if(p_value > alpha_test){
 print("We cannot reject the null hypothesis. The average winter values in this data are the same as the average summer values")
}else{
    print("We can reject the null hypothesis in favour of the alternative hypothesis. The average winter values in this data are significantly different to the average winter values")}
```
```

